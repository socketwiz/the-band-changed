define(["jquery","scripts/util.instances","scripts/util.model","scripts/documentHelper","scripts/jquery.dotdotdot","scripts/jquery.jplayer","scripts/overlay"],function(t,i,s,e){var l,h,o,a="wsb-media-audioplayer",r="designer",n="mobile",d="AudioPlayerAutoStart",u="AudioPlayerLoop",p="AudioPlayerShuffle",c="AudioPlayerShowPlayList",y="AudioPlayerDescription",g="albumImageUrl",f="assets",m="AudioPlayerMetaData",$='<li title="{0} {1}"><span class="pos">{2}.</span><span class="title">{0}</span><span class="length">{3}</span></li>';return l=function(t,i){this.$element=t,this.model=new s(i),this.mode=this.model.get("mode"),this.i18N=this.model.get("i18N"),this.amdRoot=this.model.get("amdRoot"),this.subscriptions=[],this.songs=[],this.playlist=[],this.playerReady=!1,this.playing=!1,this.queued=!1,this.current=0,this.shuffle=!1,this.loop=!1,this.$player=!1,this.$overlay=!1,this.$details=void 0,this.$art=void 0,this.$name=void 0,this.$author=void 0,this.$length=void 0,this.$desc=!1,this.$controls=void 0,this.$loop=void 0,this.$shuffle=void 0,this.$back=void 0,this.$forward=!1,this.$playlist=void 0,this.$ul=!1,this.mode===r&&(this.lastDescription=!1,this.hadPlaylist=!1),this.init()},l.prototype={init:function(){var i=this,s=this.$element.attr("id");this.$player=t("<div></div>").attr("id",s+"-player").appendTo(this.$element),this.mode===r&&(this.$overlay=t("<div></div>").appendTo(this.$element).css({position:"absolute",top:0,filter:"alpha(opacity = 0)","background-color":"transparent"})),this.$details=t("."+a+"-details",this.$element),this.$art=t(".art",this.$details),this.$name=t(".name",this.$details),this.$author=t(".author",this.$details),this.$length=t(".length",this.$details),this.$desc=t("."+a+"-desc",this.$element),this.$controls=t("."+a+"-controls",this.$element),this.$shuffle=t(".shuffle",this.$details),this.$loop=t(".loop",this.$details),this.$playlist=t("."+a+"-playlist",this.$element),this.$ul=t("ul",this.$playlist),this.mode!==r&&(this.mode===n?(this.$shuffle.hide(),this.$loop.hide()):(this.$shuffle.bind("click",function(){i.toggleShuffle(),i.buildPlaylist()}),this.$loop.bind("click",function(){i.toggleLoop()})),this.$back=t(".back",this.$controls).bind("click",function(){var t=i.playlist.length;1==t?i.playerReady&&i.$player.jPlayer(i.playing?"play":"pause",0):i.current-1<0?i.load(t-1,i.playing):i.load(i.current-1,i.playing)}),this.$forward=t(".forward",this.$controls).bind("click",function(){var t=i.playlist.length;1==t?i.playerReady&&i.$player.jPlayer(i.playing?"play":"pause",0):i.current+1>=t?(i.shuffle&&i.shuffleSongs(),i.load(0,i.playing)):i.load(i.current+1,i.playing)}),this.$player.jPlayer({ready:function(){i.playerReady=!0,i.queued&&i.queued.length&&l.prototype.load.apply(i,i.queued)},swfPath:i.amdRoot+"/libs/jplayer/",preload:this.model.get(d)?"none":"auto",smoothPlayBar:!0,backgroundColor:"#000000",cssSelectorAncestor:"#"+s+" ."+a+"-controls",cssSelector:{play:".play",pause:".pause",seekBar:".progress > div",playBar:".progress > div > span",currentTime:".progress-time"},errorAlerts:!1,warningAlerts:!1}).bind(t.jPlayer.event.play,function(){i.playing=!0}).bind(t.jPlayer.event.pause,function(){i.playing=!1}).bind(t.jPlayer.event.ended,function(){var t=i.playlist.length;i.current+1>=t?i.loop?1==t?i.$player.jPlayer("play",0):(i.shuffle&&i.shuffleSongs(),i.load(0,!0)):i.$player.jPlayer("pause",0):i.load(i.current+1,!0)})),this.refresh()},refresh:function(){var i=this,s=this.model.get(m);this.songs=t.map(this.model.get(f),function(i,l){return s[l]?{pos:l+1,src:i.src||e.getDocumentUrl(i.id),title:t.trim(s[l].title||s[l].Title||""),author:t.trim(s[l].author||s[l].Author||""),length:t.trim(s[l].length||s[l].Length||"0:00")}:null}),this.playlist=this.songs.slice(0),this.$element.sfMsgOverlay(this.songs.length?{message:null}:{message:this.i18N.resources.Client__Playlist_is_empty,style:null});var l=this.model.get(g);if(t(".tags",this.$details).toggleClass("with-img",0!=l),l){this.$art.addClass("loading").show().html("");var o=t("<img/>").bind("load",function(){o.appendTo(i.$art.removeClass("loading")).css(h(o,i.$art)).unbind("load")});o[0].src=l}else this.$art.hide();var a=t.trim(this.model.get(y));this.$desc.toggle(!!a).find("p").text(a),this.toggleShuffle(this.model.get(p)),this.toggleLoop(this.model.get(u));var $=this.model.get(c),v=Math.ceil(this.$controls.position().top+this.$controls.outerHeight())-1;if(this.$playlist.toggle($),$?(this.$playlist.css("top",v),this.buildPlaylist()):this.$ul.children().remove(),this.load(0,this.mode!==n&&this.model.get(d)),this.mode===r){if(this.model.set("minHeight",v),!this.model.model||!this.model.model.undoer)return;var b=this.model.model.undoer;if(b.getCurrentState().isCollect){var P=v+1;($&&!this.hadPlaylist||$&&this.hadPlaylist&&a!==this.lastDescription)&&(P+=30*this.playlist.length),this.model.get("Height").replace("px","")<P&&this.model.set("Height",P+"px")}this.$overlay.css({width:this.$element.width(),height:this.$element.height()}),this.lastDescription=a,this.hadPlaylist=$}},load:function(t,i){var s=this.playlist[t];s&&(this.playerReady||this.mode===r?(this.playerReady&&(this.$player.jPlayer("setMedia",{mp3:s.src}),i&&this.$player.jPlayer("play")),this.$name.text(s.title).attr("title",s.title).dotdotdot({height:60}),this.$author.text(this.i18N.resources.Client__by.sfFormat(s.author)),this.$length.text(this.i18N.resources.Client__Length+" "+s.length),this.current=t,this.$ul.children().removeClass("active").eq(t).addClass("active")):this.queued=arguments)},shuffleSongs:function(){for(var t,i,s=this.playlist.splice(this.current,1),e=this.playlist.length;e>0;)t=Math.random()*e--|0,i=this.playlist[e],this.playlist[e]=this.playlist[t],this.playlist[t]=i;this.playlist=this.playlist.slice(0,this.current).concat(s,this.playlist.slice(this.current))},toggleShuffle:function(t){if(this.shuffle=void 0!==t?!!t:!this.shuffle,this.$shuffle.toggleClass("active",this.shuffle),this.$ul.toggleClass("shuffled",this.shuffle),this.shuffle)this.shuffleSongs();else{var i=this.playlist[this.current];this.playlist=this.songs.slice(0);for(var s=0;s<this.playlist.length;s++)if(this.playlist[s].pos===i.pos){this.current=s;break}}},toggleLoop:function(t){this.loop=void 0!==t?!!t:!this.loop,this.$loop.toggleClass("active",this.loop)},buildPlaylist:function(){this.$ul.children().remove();for(var t=0;t<this.playlist.length;t++)this.$ul.append(this.buildLi(t,this.playlist[t]));this.$ul.children().eq(this.current).addClass("active")},buildLi:function(i,s){var e=this,l=e.i18N.resources.Client__by.sfFormat(s.author),h=t($.sfFormat(s.title,l,s.pos,s.length));return this.mode!==r&&h.bind("click",function(){e.load(i,e.playing)}),h},destroy:function(){for(var t in this.subscriptions)this.subscriptions[t].dispose();o.destroy(this.$element),this.$element.remove()}},h=function(t,i){var s=t.width(),e=t.height(),l=e/s,h=i.width(),o=i.height(),a=o/h,r=0,n=0,d=void 0,u=void 0;return 1>l?1>a&&l>a?n=h:r=o:l>1?a>1&&a>l?r=o:n=h:1>a?n=h:r=o,r?d=-(s*(r/e)-h)/2:u=-(e*(n/s)-o)/2,{width:n||"auto",height:r||"auto",left:d,top:u}},t.jPlayer.timeFormat.padMin=!1,o=new i(a,l),{render:function(t,i){var s=o.get(t);return s?s.refresh():s=o.create(t,i),s},destroy:function(t){var i=o.get(t);return i?(i.destroy(),!0):!1}}});
//# sourceMappingURL=media.audioplayer.js.map
