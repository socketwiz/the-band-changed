define(["designer/util/util.instances","designer/util/util.model","common/util/documentHelper","jquery","libs/fancybox/fancybox"],function(e,t,i,s){function o(e,i){this.$element=e,this.model=new t(i),this.mode=this.model.get("mode"),this.i18N=this.model.get("i18N"),this.subscriptions=[],this.init()}var a="wsb-media-carousel",n=/(msie) ([\w.]+)/.exec(window.navigator.userAgent.toLowerCase()),l=n&&3===n.length&&"msie"===n[1]&&parseInt(n[2],10)<11;o.prototype={$titleTemplate:!1,init:function(){var e=this;if(this.model.isKO){var t=function(){e.refresh()};this.subscriptions.push(this.model.get("localizedAssets",!0).subscribe(t));var i=this.model.get("mutatorViewModel",!0);if(i)for(var o in i)this.model.ko.isObservable(i[o])&&this.subscriptions.push(i[o].subscribe(t))}this.$titleTemplate||(this.$titleTemplate=s("<div/>").addClass("fancybox-title fancybox-title-float-wrap").append(s("<span/>").addClass("child"))),this.refresh("designer"==this.mode&&this.model.get("isNew"))},refresh:function(e){this.assets=this.model.get("localizedAssets")||this.model.get("CarouselAssets"),this.$element.children().remove();for(var t=0;t<this.assets.length;t++)this.addAsset(this.assets[t],t+1);if("designer"==this.mode)this.model.set("minWidth",s("> a:first",this.$element).outerWidth(!0)),this.model.set("isNew",e),this.updateOverlay();else if("desktop"==this.mode||"mobile"==this.mode){var i=this,o=!1,a=s("a",this.$element),n=this.model.get("preview"),l=this.model.get("CarouselCaption");a.selector="",a.fancybox({afterLoad:function(e){o=e},afterShow:function(){if(o){var e=i.assets[o.index];if(e&&(s(".fancybox-next").attr("title",i.i18N.resources.Next),s(".fancybox-prev").attr("title",i.i18N.resources.Previous),l||e.link)){var t=s(".fancybox-title",o.theme);if(t.length||(t=i.$titleTemplate.clone().insertAfter(s(".fancybox-outer",o.skin))),e.link){var a=s("<a/>").addClass("fancy-title-float-wrap-link");if(e.link.search("window.wsb.gotoAddress")>=0){var r=e.link.match(/preview\/(?:desktop|mobile)\/(?:(?:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})|(?:\d+))/)[0];a.attr("href","#").click(function(){window.wsb.gotoAddress(r)})}else a.attr("href",e.link);Boolean(e.link.match(/^((http|https|ftp|mailto):|\/\/)/i))?a.attr("target","_blank"):n&&a.one("click",function(){s.fancybox.close()}),a.appendTo(t)}l&&!e.caption&&s("span",t).text(i.i18N.resources.Image+" "+(o.index+1)+"/"+i.assets.length)}}},beforeClose:function(){o=!1}})}},updateOverlay:function(){var e=s("."+a+"-overlay",this.$element);e.length||s("<div/>").addClass(a+"-overlay").css(l?{filter:"alpha(opacity = 0.01)","background-color":"background:rgba(0,0,0,0.01);"}:{filter:"alpha(opacity = 0)","background-color":"transparent"}).appendTo(this.$element)},addAsset:function(e){var t,o=this,n=e.src||i.getDocumentUrl(e.id),l=this.model.get("CarouselCaption")&&e.caption?e.caption:null,r=n,d=null;"mobile"==this.mode&&e.link&&(e.link.search("window.wsb.gotoAddress")>=0&&(t=e.link.match(/preview\/(?:desktop|mobile)\/(?:(?:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})|(?:\d+))/)[0]),Boolean(e.link.match(/^((https?|ftp|file):\/{2}|mailto:)/i))&&(d="_blank"));var h=s("<a/>").addClass(a+"-wrapper").addClass("loading").css({height:"100%",width:"100%"}).attr({rel:a+"-"+this.mode+"-"+this.model.get("ID"),href:r,title:l,target:d,"data-fancybox-type":"image"}).css({height:this.model.get("CarouselThumbSize"),width:this.model.get("CarouselThumbSize"),margin:this.model.get("CarouselThumbSpacing"),display:"inline-block","vertical-align":"middle"}).appendTo(this.$element);"mobile"==this.mode&&t&&h.click(function(){window.wsb.gotoAddress(t)});var c=s("<img/>").bind("load",function(){c.appendTo(h.removeClass("loading"));var e=c.width(),t=c.height(),i=h.width(),s=h.height();c.css(e>t?{height:s,left:-(e*(s/t)-i)/2}:t>e?{width:i,top:-(t*(i/e)-s)/2}:{width:i,height:s});var a=o.model.get("CarouselTheme");a&&h.addClass(a),c.unbind("load")});c[0].src=n},destroy:function(){for(var e in this.subscriptions)this.subscriptions[e].dispose();r.destroy(this.$element),this.$element.remove()}};var r=new e(a,o);return{render:function(e,t){var i=r.get(e);return i?i.refresh():i=r.create(e,t),i},destroy:function(e){var t=r.get(e);return t?(r.destroy(e),!0):!1}}});
//# sourceMappingURL=media.lightbox.js.map